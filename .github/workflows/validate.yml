name: Validate Ontology and Docs

on:
  push:
  pull_request:

jobs:
  python-validate:
    name: Python SHACL validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install rdflib pyshacl
      - name: Validate sample JSON-LD against SHACL
        run: |
          python - << 'PY'
          from rdflib import Graph
          from pyshacl import validate
          data = Graph()
          data.parse("examples/sample_score.json", format="json-ld")
          shapes = Graph()
          shapes.parse("goblin-shapes.ttl", format="turtle")
          conforms, report_graph, report_text = validate(data_graph=data, shacl_graph=shapes, inference='rdfs', advanced=True)
          print(report_text)
          assert conforms, "SHACL validation failed"
          PY
  dot-check:
    name: Render DOT and check committed artifacts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz
      - name: Render goblin-map
        run: |
          dot -Tsvg goblin-map.dot -o docs/goblin-map.svg.new
          dot -Tpng goblin-map.dot -o docs/goblin-map.png.new
      - name: Fail if diffs vs committed images
        run: |
          set -e
          if ! cmp --silent docs/goblin-map.svg docs/goblin-map.svg.new; then
            echo "docs/goblin-map.svg differs from generated. Please regenerate and commit."
            exit 1
          fi
          if ! cmp --silent docs/goblin-map.png docs/goblin-map.png.new; then
            echo "docs/goblin-map.png differs from generated. Please regenerate and commit."
            exit 1
          fi
  docs-link:
    name: Verify docs links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check docs/kg.html references
        run: |
          set -e
          test -f docs/goblin-map.svg
          test -f docs/goblin-map.png
          test -f goblin-ontology.ttl
          test -f goblin-shapes.ttl
          grep -q "goblin-map.svg" docs/kg.html
          grep -q "goblin-ontology.ttl" docs/kg.html
          grep -q "goblin-shapes.ttl" docs/kg.html
